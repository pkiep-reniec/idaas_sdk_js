var ReniecIdaasConst={ACR_ONE_FACTOR:"one_factor",ACR_TWO_FACTOR:"two_factor",ACR_PKI_DNIE:"pki_dnie",ACR_PKI_TOKEN:"pki_token",ACR_ONLY_PASSWORD:"only_password",ACR_ONLY_QUESTIONS:"only_questions",PKI_DNIE_MOBILE:"pki_dnie_mobile",FINGERPRINT_MOBILE:"fingerprint_mobile",PKI_DNIE_LEGACY:"pki_dnie_legacy",PKI_TOKEN_LEGACY:"pki_token_legacy",PROMPT_NONE:"none",PROMPT_LOGIN:"login",PROMPT_CONSENT:"consent",SCOPE_PROFILE:"profile",SCOPE_EMAIL:"email",SCOPE_PHONE:"phone",SCOPE_OFFLINE_ACCESS:"offline_access",RESPONSE_TYPE_CODE:"code",RESPONSE_TYPE_ID_TOKEN:"id_token",RESPONSE_TYPE_TOKEN:"token",EVENT_LOADED:"ReniecIDaaS_loaded",EVENT_CONNECTED:"ReniecIDaaS_connected",EVENT_CANCEL:"ReniecIDaaS_cancel",ERROR_INVALID_ORIGIN_JS:"ReniecIDaaS_invalid_origin_js",EVENT_AUTH_COMPLETE:"ReniecIDaaS_auth_complete",EVENT_RELOAD:"ReniecIDaaS_reload",EVENT_AUTH_RELOAD:"ReniecIDaaS_auth_reload",EVENT_AUTH_CANCEL:"ReniecIDaaS_auth_cancel"},idaasUris={service:"https://idaas.reniec.gob.pe/service",auth:"https://idaas.reniec.gob.pe/service/auth",token:"https://idaas.reniec.gob.pe/service/token",userInfo:"https://idaas.reniec.gob.pe/service/userinfo",logout:"https://idaas.reniec.gob.pe/service/logout"},title="RENIEC IDaaS",availableParams={clientId:null,scopes:[],acr:null,prompts:[],responseTypes:[],maxAge:null,loginHint:null},popup=null,onCancelAction=null,onSuccessAction=null,onLoadAction=null,state=null,nonce=null,isReload=!1,loadedFired=!1,authReload=!1,ReniecIDaaS={init:function(e){initConfig(e)},auth:function(){url=getLoginUrl(!1),openPopup(url,title,400,650)},authPreload:function(){url=getLoginUrlPreload(),openPopup(url,title,400,650)},authReload:function(e){initConfig(e),authParams=getLoginUrl(!0),authReload=!0,popup.postMessage({event:ReniecIdaasConst.EVENT_AUTH_RELOAD,data:authParams},"*")},logout:function(e){url=idaasUris.logout+"?"+encodeQueryData({post_logout_redirect_uri:e}),location.href=url},onLoad:function(e){onLoadAction=e},onCancel:function(e){onCancelAction=e},onSuccess:function(e){onSuccessAction=e}};function initConfig(e){Array.isArray(e.scopes)?e.scopes.push("openid"):e.scopes=["openid"],availableParams.clientId=e.clientId||null,availableParams.acr=e.acr||null,availableParams.responseTypes=Array.isArray(e.responseTypes)?e.responseTypes:[ReniecIdaasConst.RESPONSE_TYPE_ID_TOKEN],availableParams.scopes=e.scopes,availableParams.prompts=Array.isArray(e.prompts)?e.prompts:[],availableParams.maxAge=isNaN(e.maxAge)||""==e.maxAge?null:e.maxAge,availableParams.loginHint=e.loginHint||null}function getLoginUrl(e){try{return state=Date.now()+""+Math.random(),nonce="N"+Math.random()+Date.now(),params={client_id:availableParams.clientId,response_type:availableParams.responseTypes.join(" "),state:state,nonce:nonce,scope:availableParams.scopes.join(" "),popup:!0},0<availableParams.prompts.length&&(params.prompt=availableParams.prompts.join(" ")),null!==availableParams.acr&&(params.acr_values=availableParams.acr),null!==availableParams.maxAge&&(params.max_age=availableParams.maxAge),null!==availableParams.loginHint&&(params.login_hint=availableParams.loginHint),e?params:(url=idaasUris.auth+"?"+encodeQueryData(params),url)}catch(e){console.error(e)}return null}function getLoginUrlPreload(){return url=idaasUris.service+"/preload-js",url}function openPopup(e,n,a,o){dualScreenLeft=null!=window.screenLeft?window.screenLeft:window.screenX,dualScreenTop=null!=window.screenTop?window.screenTop:window.screenY,width=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width,height=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,left=width/2-a/2+dualScreenLeft,top=height/2-o/2+dualScreenTop,popup=window.open(e,n,"toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=no,resizable=no,copyhistory=no,width="+a+",height="+o+",top="+top+",left="+left),window.focus&&popup.focus()}function parseJwt(e){return base64Url=e.split(".")[1],base64=base64Url.replace("-","+").replace("_","/"),JSON.parse(window.atob(base64))}function encodeQueryData(e){for(d in ret=[],e)ret.push(encodeURIComponent(d)+"="+encodeURIComponent(e[d]));return ret.join("&")}function procUserInfo(e,n){http=new XMLHttpRequest,params="access_token="+e,http.open("POST",idaasUris.userInfo,!0),http.setRequestHeader("Content-type","application/x-www-form-urlencoded"),http.onreadystatechange=function(){4==http.readyState&&(200==http.status?(result=JSON.parse(http.responseText),n(result)):(console.error("Error fetching userinfo."),n(null)))},http.send(params)}function procFinalResponse(e){"function"==typeof onSuccessAction&&onSuccessAction(e)}function resetInitial(){isReload=loadedFired=!1}window.addEventListener("message",function(e){if(0===idaasUris.auth.indexOf(e.origin))switch(e.data.event){case ReniecIdaasConst.EVENT_LOADED:loadedFired&&!authReload||(authReload=!1,console.info("Event fired: "+ReniecIdaasConst.EVENT_LOADED),popup.postMessage({event:ReniecIdaasConst.EVENT_CONNECTED,code:e.data.code},"*"),"function"!=typeof onLoadAction||loadedFired||onLoadAction(),loadedFired=!0);break;case ReniecIdaasConst.EVENT_AUTH_COMPLETE:if(resetInitial(),console.info("Event fired: "+ReniecIdaasConst.EVENT_AUTH_COMPLETE),state==e.data.data.state){if(e.data.data.error){console.info(e.data.data.error),console.info(e.data.data.error_description),"function"==typeof onCancelAction&&onCancelAction();break}var n=parseJwt(e.data.data.id_token);if(nonce===n.nonce){var a={idToken:e.data.data.id_token,idTokenParser:n};e.data.data.access_token?procUserInfo(e.data.data.access_token,function(e){a.userInfo=e,procFinalResponse(a)}):procFinalResponse(a)}else console.error("Wrong nonce")}else console.error("Wrong state");break;case ReniecIdaasConst.EVENT_RELOAD:console.info("Event fired: "+ReniecIdaasConst.EVENT_RELOAD),isReload=!0;break;case ReniecIdaasConst.EVENT_CANCEL:isReload||(resetInitial(),console.info("Event fired: "+ReniecIdaasConst.EVENT_CANCEL),"function"==typeof onCancelAction&&onCancelAction()),isReload=!1;break;case ReniecIdaasConst.ERROR_INVALID_ORIGIN_JS:console.info("Event fired: "+ReniecIdaasConst.ERROR_INVALID_ORIGIN_JS),console.info(e.data.message),resetInitial(),"function"==typeof onCancelAction&&onCancelAction()}});